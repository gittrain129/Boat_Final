<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.boat.mybatis.mapper.FileboMapper">
  
	<select id="getListCount" resultType="int">
		select count(*) from board3
	</select>
	
  <select id = "getBoardList" resultType="Filebo" parameterType="java.util.Map">
	
	
  
   SELECT * FROM (select rownum rnum, j.* from (
							 select board3.*, nvl(CNT ,0) CNT 
							from board3 left outer join (select board_num,count(*) CNT  
														from comments3 
														group by board_num)b 
												on board3.board_num = b.board_num  
							order by board_re_ref desc,  
							board_re_seq asc)j
							 				where rownum&lt;=  #{end}   ) 
							WHERE rnum&gt;= #{start}  and rnum&lt;= #{end}  
  
  </select>
  
  			 
  <insert id = "insertBoard" parameterType = "Filebo">
	  <selectKey resultType="int" order ="BEFORE" keyProperty ="FILE_NUM">
	  	 select nvl(max(BOARD_NUM),0)+1 from board3
	  
	  </selectKey>
	 insert into board3
  (BOARD_NUM,BOARD_NAME,BOARD_PASS,BOARD_SUBJECT,
  BOARD_CONTENT,BOARD_FILE,BOARD_ORIGINAL,BOARD_RE_REF,
  BOARD_RE_LEV,BOARD_RE_SEQ,BOARD_READCOUNT,BOARD_DATE)
  values
  (
  #{BOARD_NUM},#{BOARD_NAME},#{BOARD_PASS},#{BOARD_SUBJECT},#{BOARD_CONTENT},
  #{BOARD_FILE,jdbcType=VARCHAR}, #{BOARD_ORIGINAL,jdbcType=VARCHAR},
  #{BOARD_NUM},#{BOARD_RE_LEV},#{BOARD_RE_SEQ},#{BOARD_READCOUNT},SYSDATE)
  </insert>
  
  <select id ="getDetail" parameterType ="Filebo" resultType = "Filebo">
	select * from board3 
   where 
  BOARD_NUM = #{number}
  </select>
  
  <update id="setReadCountUpdate" parameterType ="int">
	update board3
  set BOARD_READCOUNT = BOARD_READCOUNT+1
  where BOARD_NUM = #{number}
  </update>
  
  <!--  map은 java.util.Map의 별칭입니다.-->
  <select id = "isBoardWriter" parameterType = "map" resultType="Filebo" >
 select * from board3
  where BOARD_NUM=#{num}
  and BOARD_PASS=#{pass}
  </select>
  
  <update id="boardModify" parameterType = "Filebo" >
	update board3
  set
  BOARD_SUBJECT = #{BOARD_SUBJECT},
  BOARD_CONTENT = #{BOARD_CONTENT},
  BOARD_FILE  = #{BOARD_FILE,jdbcType=VARCHAR},
  BOARD_ORIGINAL = #{BOARD_ORIGINAL,jdbcType=VARCHAR}
 where
  BOARD_NUM =#{BOARD_NUM}
  
  </update>
  
  <insert id = "boardReply" parameterType = "Filebo">
  	<selectKey resultType="int" order ="BEFORE" keyProperty ="FILE_NUM">
 		 select nvl(max(BOARD_NUM),0)+1 from board3
  	</selectKey>
 insert into board3
					(BOARD_NUM,BOARD_NAME,BOARD_PASS,BOARD_SUBJECT,
					BOARD_CONTENT, BOARD_RE_REF,
					BOARD_RE_LEV, BOARD_RE_SEQ, BOARD_READCOUNT,BOARD_DATE) 
values( #{BOARD_NUM},#{BOARD_NAME},#{BOARD_PASS},#{BOARD_SUBJECT},#{BOARD_CONTENT},
					#{BOARD_RE_REF},#{BOARD_RE_LEV},#{BOARD_RE_SEQ},#{BOARD_READCOUNT},sysdate)
  </insert>
  
  <update id = "boardReplyUpdate" parameterType = "Filebo">
  	  update board3 set BOARD_RE_SEQ = BOARD_RE_SEQ+1 
					where BOARD_RE_REF = #{BOARD_RE_REF}
					and BOARD_RE_SEQ <![CDATA[ > ]]> #{BOARD_RE_SEQ}
  </update>
  
  <delete id="boardDelete" parameterType = "int">
 <![CDATA[
  delete from board3 
			where BOARD_RE_REF = #{BOARD_RE_REF} 
			and BOARD_RE_LEV  > =#{BOARD_RE_LEV} 
			and BOARD_RE_SEQ  > =#{BOARD_RE_SEQ} 
			and BOARD_RE_SEQ  < =(  
							 		nvl((select min(BOARD_RE_SEQ) -1 
									  from board3
									  where BOARD_RE_REF = #{BOARD_RE_REF} 
									  and BOARD_RE_LEV = #{BOARD_RE_LEV}
									  and BOARD_RE_SEQ  > #{BOARD_RE_SEQ}),
									(select max(BOARD_RE_SEQ)
								 		from board3
										 where BOARD_RE_REF = #{BOARD_RE_REF})))
  ]]>
  </delete>
   <select id ="getDeleteFileList" resultType ="String"> 
   select board_file from delete_file
  </select>
  
  <delete id="deleteFileList" parameterType ="String">
  delete from delete_file where board_file=#{filename}
  </delete>
  
 </mapper>