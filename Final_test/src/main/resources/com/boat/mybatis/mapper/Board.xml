<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boat.mybatis.mapper.BoardMapper">

	<select id="getListCount" resultType="int">
		select count(*) from board
	</select>
	

	<select id="getBoardList" resultType="Board">
  select * from
  (
    select rownum rnum, b.*
    from
    (
      select board.*, nvl(cnt, 0) cnt
      from board
      left outer join
      (
        select board_num, count(*) cnt
        from comments
        group by board_num
      ) c on board.board_num = c.board_num
      order by BOARD_NOTICE desc, BOARD_RE_REF desc, BOARD_RE_SEQ asc
    ) b
    where rownum &lt;= #{end}
  )
  where rnum &gt;= #{start} and rnum &lt;= #{end}
</select>
	
	
	<insert id = "insertBoard">
		<selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
			select nvl(max(BOARD_NUM), 0)+1 from board	
		</selectKey>
		insert into board(BOARD_NUM, BOARD_NAME, BOARD_PASS, BOARD_SUBJECT, BOARD_CONTENT, BOARD_DEPT, BOARD_RE_REF, BOARD_RE_LEV, BOARD_RE_SEQ, BOARD_READCOUNT, BOARD_DATE,BOARD_EMPNO,BOARD_NOTICE,BOARD_JOB)
		values(#{BOARD_NUM}, #{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT}, #{BOARD_CONTENT},#{BOARD_DEPT}, #{BOARD_NUM}, #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT}, sysdate,#{BOARD_EMPNO},#{BOARD_NOTICE},#{BOARD_JOB})
	</insert>
	
	<update id="setReadCountUpdate">
		update board set BOARD_READCOUNT=BOARD_READCOUNT+1 where BOARD_NUM=#{number}
	</update>
	
	<select id="getDetail" resultType="board">
		select * from board where BOARD_NUM = #{number}
	</select>
	
		
	<select id="isBoardWriter" resultType="board">
		select * from board where BOARD_NUM = #{num} and BOARD_PASS=#{pass}
	</select>
	
	<update id="boardModify">
      update board
      set BOARD_SUBJECT = #{BOARD_SUBJECT},
         BOARD_CONTENT = #{BOARD_CONTENT},
         BOARD_FILE = #{BOARD_FILE},
         BOARD_ORIGINAL = #{BOARD_ORIGINAL}
         
      where BOARD_NUM=#{BOARD_NUM}
   </update>
   
   <update id="boardReplyUpdate">
   	update board set BOARD_RE_SEQ=BOARD_RE_SEQ+1 WHERE BOARD_RE_REF=#{BOARD_RE_REF} and BOARD_RE_SEQ<![CDATA[>]]> #{BOARD_RE_SEQ}
   </update>
   
	<insert id = "boardReply">
		<selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
			select nvl(max(BOARD_NUM), 0)+1 from board	
		</selectKey>
		insert into board(BOARD_NUM, BOARD_NAME, BOARD_PASS, BOARD_SUBJECT, BOARD_CONTENT, BOARD_RE_REF, BOARD_RE_LEV, BOARD_RE_SEQ, BOARD_READCOUNT, BOARD_DATE)
		values(#{BOARD_NUM}, #{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT}, #{BOARD_CONTENT}, #{BOARD_RE_REF}, #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT}, sysdate)
	</insert>
	
	<delete id="boardDelete">
	<![CDATA[
		delete from board
			where BOARD_RE_REF=#{BOARD_RE_REF}
			and BOARD_RE_LEV>=#{BOARD_RE_LEV}
			and BOARD_RE_SEQ>=#{BOARD_RE_SEQ}
			and BOARD_RE_SEQ <= ( nvl((SELECT min(board_re_seq)-1 FROM board 
											where BOARD_RE_REF=#{BOARD_RE_REF}
											and BOARD_RE_LEV=#{BOARD_RE_LEV}
											and BOARD_RE_SEQ>#{BOARD_RE_SEQ}),
											(SELECT max(board_re_seq) FROM board WHERE BOARD_RE_REF = #{BOARD_RE_REF})))
	
	]]>
	</delete>
	
		<insert id = "insertFav" parameterType = "Board">
		insert into board_fav(BOARD_NUM, BOARD_EMPNO)
		values(#{bOARD_NUM},#{bOARD_EMPNO})
	</insert>
	
	<select id="getFavListCount" resultType="int">
		select count(*) from board_fav
	</select>

	<select id="getFavBoardList" resultType="Board">
	select * from
		(select rownum rnum, b.*
		 from (
		 	select board.*, nvl(cnt, 0) cnt
		 	 from board 
		 	 	left outer join
		 	 		(select board_num, count(*) cnt from comments group by board_num)
		 	 		 c on board.board_num = c.board_num 
		 	 		 where board.board_num in (
        				select board_num from board_fav where board_empno = #{BOARD_EMPNO}
      					)
		 	 		 order by BOARD_RE_REF desc,
					BOARD_RE_SEQ asc) b
			where rownum &lt;= #{end}
		)
		where rnum &gt;= #{start} and rnum &lt;= #{end}
	</select>

</mapper>