<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<jsp:include page="../template/HeadTagSetting.jsp"/>
		<title>Employee leave</title>
		<script>
			var date;
			$.post(location.href, function(data,status,xhr){
	//			alert(xhr.getResponseHeader("Date"));
				date = new Date(xhr.getResponseHeader("Date"));
			}).done(function() {
	//			alert( "location.href success" );
			}).fail(function() {
	//			alert( "location.href error" );
			}).always(function() {
	//			alert( "location.href finished" );
	//			$(location).attr("href", "SimpleInsertVocation.jsp");
			});

			var vacationDateArr = [];
			$(document).ready(function() {
			
				var calendar = $('#calendar').fullCalendar({
					header: {
						left: 'prev,next today',
						center: 'title',
						right: 'month'
					},
					selectable: true,
					selectHelper: true,
					select: function( startDate, endDate, allDay, jsEvent, view ) {
						
						if (startDate < date){
							alert("오늘 이후만 가능합니다.");
							return;
						} else if (!confirm("휴가를 등록하시겠습니까?"))	return;
						
						var startDay; var endDay;
						
						if (new Date(startDate) > new Date(endDate)) {
							startDay = new Date(endDate);
							endDay = new Date(startDate);
						} else {
							startDay = new Date(startDate);
							endDay = new Date(endDate);
						}
						
						
						for ( var i in vacationDateArr) {
							
							// 하나 클릭
							if (startDay.toDateString() == endDay.toDateString()) {
								if (vacationDateArr[i].getTime() == startDay.getTime()) {
									alert("이미 신청하였습니다.");
									return;
								}
							// 다중 클릭
							} else {
								for ( var j = startDay.getTime() ; j < endDay.getTime() ; j = j + 86400000) {
									if (vacationDateArr[i].getTime()  == j) {
										alert("휴가가 겹치는 날이 있습니다.");
										return;
									}
								}
							}
						}
						
						
						var startYear = startDay.getFullYear();
						var startMonth = startDay.getMonth() + 1;
						var startDate = startDay.getDate();
						
						var endYear = endDay.getFullYear();
						var endMonth = endDay.getMonth() + 1;
						var endDate = endDay.getDate();
						var gap = (endDay - startDay) / 86400000;
						
						var url = 'multiInsertVacation.go'
							+ '?startDay=' + startDay
							+ '&startYear=' + startYear
							+ '&startMonth=' + startMonth
							+ '&startDate=' + startDate
							+ '&endDay=' + endDay
							+ '&endYear=' + endYear
							+ '&endMonth=' + endMonth
							+ '&endDate=' + endDate
							+ '&gap=' + gap;
						
						$(this).css('background-color', 'red');

						$.post(url, function() {
						}).always(function() {
							location.replace("vacation.go");
//							$(location).attr("href", "SimpleInsertVocation.jsp");
						});
					},
					events: [
					         
				
						{
							id: '',
							title: '휴가',
							start: new Date()
						},
						
						{}
					], eventClick: function(calEvent, jsEvent, view) {
						if (!window.confirm("휴가를 삭제하시겠습니까?")) return;
						
						calendar.fullCalendar('removeEvents', calEvent.id);
						location.href = "deleteVacation.go?id=" + calEvent.id;
						
				    }, eventRender: function(event, element) {
				    	vacationDateArr.push(event.start);
				    }
				});
				
			});
		
		</script>
	</head>
	<body>
		<div class="container-fluid">
			<jsp:include page="../template/TopTemplate.jsp"/>
			<div class="row">
				<div class="span3">
					<jsp:include page="../template/employee/em_menu.jsp"/>
				</div>
				<div class="span9">	
					<div id='calendar'></div>
				</div>
			</div>
			<jsp:include page="../template/BottomTemplate.jsp"/>
		</div>
	</body>
</html>